###
modbus通讯协议学习
---

**什么是modbus？**

*   概况
    -   Modbus是一种串行通信协议，是Modicon公司（现在的施耐德电气Schneider Electric）于1979年为使用可编程逻辑控制器（PLC）通信而发表。
    -   Modbus 协议是 **应用于电子控制器上的一种通用语言**。通过此协议，控制器相互之间、控制器经由网络（例如以太网）和其它设备之间可以通信。
    -   Modbus 协议定义了一个控制器能认识使用的消息结构,而不管它们是经过何种网络进行通信的。它描述了一控制器请求访问其它设备的过程，如果回应来自其它设备的请求，以及怎样侦测错误并记录。它制定了消息域格局和内容的公共格式。
    -   **Modbus 是一个请求/应答协议**Modbus​是​使用​主从关系​实现​的​请求 - 响应​。
*   modbus的功能：
    -   数据定义
    -   标准格式
*   传输方式：
    -   ASCII模式
    -   RTU模式
    -   TCP模式
*  消息帧
    -  各种数据转换成十六进制
    -  ASCII消息帧
    -  RTU消息帧
*  数据校验方式
    -  CRC：循环冗长检测
    -  LRC：纵向冗长检测
    -  奇偶校验
    -  自定义校验
*  传输过程
    -  查询
    -  回应
    -  主一从
*  调试工具
    -  软件调试
        -  串口调试助手V2.2
        -  sscom32
        -  网络调试助手
    -  硬件调试
        +  RS232转RS485

**Modbus消息帧**

![通用Modbus帧](https://images0.cnblogs.com/blog/54346/201306/14133539-ae3867d6872f498ea12c09d5fc2079cb.png)

*   ADU：应用数据单元
*   PDU：协议数据单元
```
graph LR
A[Modbus消息帧] --> B[ASCII消息帧] --> C[LRC(纵向冗长检测)]
A --> | RTU消息帧 | CRC(循环冗长检测) |
```

**ASCII消息帧**

*   在消息中的每个8Bit 字节都作为两个ASCII字符发送
*   十六进制，ASCII字符0...9，A...F
*   消息中的每个ASCII字符都是一个十六进制字符组成
*   每个字节的位
       - 1个起始位  
       - n个数据位，最小的有效位先发送
       - 1个奇偶校验位，无校验则无
       - 1个停止位（有校验时），2个Bit（无校验时）
* 错误检测域
* LRC(纵向冗长检测)

| 起始位 | 设备地址 | 功能代码 | 数据 | LRC校验 | 结束符 |
| :--- |:---:| :---:| :---:| :---:| ---:|
| 1个字符 | 2个字符 | 2个字符 | n个字符 | 2个字符 | 2个字符 |
**有奇偶校验位**

| 起始位 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 奇偶位 | 停止位 |
| :--- |:---:|:---:|:---:|:---:|:---:| :---:| :---:| :---:| ---:|
**无奇偶校验位**

| 起始位 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 停止位 | 停止位 |
| :--- |:---:|:---:|:---:|:---:|:---:| :---:| :---:| :---:| ---:|

**RTU消息帧**

*   8位二进制，十六进制数0...9，A...F

*   消息中的每个8位域都是一个两个十六进制字符组成

*   每个字节的位
    -   1个起始位
    - 8个数据位，最小的有效位先发送
    - 1个奇偶校验位，无校验则无
    - 1个停止位（有校验时），2个Bit（无校验时）

*   错误检测域
    -CRC(循环冗长检测)

| 起始位 | 设备地址 | 功能代码 | 数据 | CRC校验 | 结束符 |
| :--- |:---:| :---:| :---:| :---:| ---:|
| T1-T2-T3-T4 | 8Bit | 8Bit | n个8Bit | 16Bit | T1-T2-T3-T4 |

**有奇偶校验位**

| 起始位 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 奇偶位 | 停止位 |
| :--- |:---:|:---:|:---:|:---:|:---:| :---:| :---:| :---:| :---:| ---:|
**无奇偶校验位**

| 起始位 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 停止位 | 停止位 |
| :--- |:---:|:---:|:---:|:---:|:---:| :---:| :---:| :---:| :---:| ---:|